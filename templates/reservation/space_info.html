{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block content %}
      <center><h1>Parking Space Information</h1></center>
      <div class="chasebox">
        <div class="container">
            <h2><a href="{% url 'user_show' id=owner.id %}">{{space.owner}}</a>'s space</h2>
            <br>
            <p><b>Location:</b> Reno, NV </p>
            <p><b>Information:</b> {{space.note}}</p>
            <p><b>Rate:</b> ${{space.parkingPrice}}.00 per hour</p>
            <br>
            <p><b>Reservation start:</b>
            <br>
            <input type="date" id="datepicker1"><input type="time"></p>
            <p><b>Reservation end:</b>
            <br>
            <input type="date" id="datepicker2"><input type="time"></p>
            <br>
            <button id="customButton" class="tbLink"
              style="padding: 6px;">Continue to Payment</button>
            <a href="{% url 'parkr_home' %}" class="tbLink"
              style="margin-left:20px;">Return Home</a>
            <input type="hidden" value="{{id}}" id="spot_id">
        </div>
      </div>
{% endblock %}

{% block script %}
    {{ block.super }}
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://checkout.stripe.com/checkout.js"></script>

    <script>
var csrftoken = Cookies.get('csrftoken');
        var handler = StripeCheckout.configure({
          key: 'pk_test_MKfo1zMYDA0i0ITx5kjkAcwK',
          image: 'https://stripe.com/img/documentation/checkout/marketplace.png',
          locale: 'auto',
          token: function(token) {
function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});
            $.ajax({
              url: "{% url 'process' %}",
              type: 'post',
              data: {
                //csrfmiddlewaretoken:{{ csrf_token }},
                stripeToken: token.id,
                end_time:$("#datepicker2").val(),
                start_time:$("#datepicker1").val(),
                spot_id:{{ id }},
              },
              dataType: 'json',
              success: function(data) {
                console.log("Success:",data.route);
                window.location.replace(data.route)
              },
              error: function(data) {
                console.log("Failed");
                console.log(data);
              }
            });
          }
        });
        document.getElementById('customButton').addEventListener('click', function(e) {
          // Open Checkout with further options:
          handler.open({
            name: 'ParkR',
            description: 'Finalize your reservation',
            amount: {{space.parkingPrice}} * 100,
          });
          e.preventDefault();
        });
        // Close Checkout on page navigation:
        window.addEventListener('popstate', function() {
          handler.close();
        });
     </script>

{% endblock %}
